import sqlite3
import pandas as pd
import os

class SalesDataProcessor:
    """Process sales data for customers aged 18â€“35. Provides both SQL and Pandas solutions."""

    def __init__(self, db_path):
        self.db_path = db_path
        self.connection = None

    def connect_database(self):
        try:
            self.connection = sqlite3.connect(self.db_path)
            print(f"Connected to database: {self.db_path}")
        except sqlite3.Error as e:
            print(f"Error connecting to database: {e}")

    def close_connection(self):
        if self.connection:
            self.connection.close()
            print("Database connection closed.")

    def solution_pure_sql(self):
        query = """
        SELECT
            c.customer_id AS Customer,
            c.age AS Age,
            i.item_name AS Item,
            CAST(SUM(od.quantity) AS INTEGER) AS Quantity
        FROM customers c
        JOIN orders o ON c.customer_id = o.customer_id
        JOIN order_details od ON o.order_id = od.order_id
        JOIN items i ON od.item_id = i.item_id
        WHERE c.age BETWEEN 18 AND 35
          AND od.quantity IS NOT NULL AND od.quantity > 0
        GROUP BY c.customer_id, c.age, i.item_name
        HAVING SUM(od.quantity) > 0
        ORDER BY c.customer_id, i.item_name;
        """
        cursor = self.connection.cursor()
        cursor.execute(query)
        results = cursor.fetchall()
        columns = [desc[0] for desc in cursor.description]
        data = [dict(zip(columns, row)) for row in results]
        print(f"Pure SQL: {len(data)} rows retrieved.")
        return data

    def solution_pandas(self):
        customers = pd.read_sql_query("SELECT * FROM customers", self.connection)
        orders = pd.read_sql_query("SELECT * FROM orders", self.connection)
        order_details = pd.read_sql_query("SELECT * FROM order_details", self.connection)
        items = pd.read_sql_query("SELECT * FROM items", self.connection)

        df = (
            customers.query("18 <= age <= 35")
            .merge(orders, on="customer_id")
            .merge(order_details, on="order_id")
            .merge(items, on="item_id")
        )

        df = df[df["quantity"].notna() & (df["quantity"] > 0)]
        grouped = (
            df.groupby(["customer_id", "age", "item_name"], as_index=False)["quantity"]
            .sum()
        )
        grouped.columns = ["Customer", "Age", "Item", "Quantity"]
        grouped["Quantity"] = grouped["Quantity"].astype(int)
        grouped = grouped.sort_values(["Customer", "Item"])
        print(f"Pandas: {len(grouped)} rows retrieved.")
        return grouped.to_dict("records")

    def save_to_csv(self, data, filename):
        df = pd.DataFrame(data)
        df.to_csv(filename, sep=";", index=False)
        print(f"Output saved to {filename}")

    def run_analysis(self):
        self.connect_database()
        sql_data = self.solution_pure_sql()
        pandas_data = self.solution_pandas()
        self.save_to_csv(sql_data, "sql_solution_output.csv")
        self.save_to_csv(pandas_data, "pandas_solution_output.csv")
        self.close_connection()

def create_sample_database():
    conn = sqlite3.connect("sample_sales.db")
    c = conn.cursor()
    c.execute("CREATE TABLE IF NOT EXISTS customers (customer_id INTEGER PRIMARY KEY, age INTEGER)")
    c.execute("CREATE TABLE IF NOT EXISTS items (item_id INTEGER PRIMARY KEY, item_name TEXT)")
    c.execute("CREATE TABLE IF NOT EXISTS orders (order_id INTEGER PRIMARY KEY, customer_id INTEGER)")
    c.execute("CREATE TABLE IF NOT EXISTS order_details (order_detail_id INTEGER PRIMARY KEY, order_id INTEGER, item_id INTEGER, quantity INTEGER)")
    
    c.executemany("INSERT INTO customers VALUES (?, ?)", [(1, 21), (2, 23), (3, 35), (4, 40)])
    c.executemany("INSERT INTO items VALUES (?, ?)", [(1, 'x'), (2, 'y'), (3, 'z')])
    c.executemany("INSERT INTO orders VALUES (?, ?)", [(1, 1), (2, 1), (3, 2), (4, 3), (5, 3)])
    c.executemany(
        "INSERT INTO order_details VALUES (?, ?, ?, ?)",
        [
            (1, 1, 1, 6), (2, 1, 2, None), (3, 1, 3, None),
            (4, 2, 1, 4), (5, 2, 2, None), (6, 2, 3, None),
            (7, 3, 1, 1), (8, 3, 2, 1), (9, 3, 3, 1),
            (10, 4, 1, None), (11, 4, 2, None), (12, 4, 3, 1),
            (13, 5, 1, None), (14, 5, 2, None), (15, 5, 3, 1)
        ]
    )
    conn.commit()
    conn.close()
    print("Sample database created: sample_sales.db")

if __name__ == "__main__":
    create_sample_database()
    processor = SalesDataProcessor("sample_sales.db")
    processor.run_analysis()
    print("Assignment completed successfully.")
